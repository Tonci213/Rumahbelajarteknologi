<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-ui-key="TITLE">Game Tebak Suara Objek Tangan</title>
    <!-- Load Tailwind CSS for responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Menggunakan font kartun yang lucu */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Fredoka', cursive;
            background: linear-gradient(135deg, #fceb0f 0%, #ff8c42 100%); /* Gradien cerah */
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }

        #game-container {
            position: relative;
            width: 95vw;
            height: 95vh;
            max-width: 1200px;
            max-height: 800px;
            border-radius: 30px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        #webcam-feed {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            transform: scaleX(-1); 
            display: block;
        }

        #control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10%; 
            background: rgba(43, 43, 43, 0.9); 
            backdrop-filter: blur(2px);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-around; 
            padding: 10px 20px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        
        /* Area Status/Tebakan di atas video */
        #status-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 12%; 
            background: none; 
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 10px 20px;
        }
        
        /* Kontainer Countdown & Hint (BARU: Lebih Kecil, Top Paling Atas) */
        #top-center-container {
            position: absolute;
            top: 20px; /* Posisikan dekat atas */
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            width: 90%;
            max-width: 900px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; 
        }

        /* Kontainer Countdown Kecil */
        #countdown-wrapper {
            background-color: white;
            border-radius: 15px;
            padding: 8px 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        /* Style KHUSUS untuk Angka Hitungan Mundur (LEBIH KECIL) */
        #countdown-display {
            font-size: 2rem; 
            line-height: 1;
            font-weight: 900;
            background: linear-gradient(90deg, #4f46e5, #818cf8); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #4f46e5; 
            animation: pulse-small 1s infinite alternate; 
        }
        
        #countdown-display.urgent {
             background: linear-gradient(90deg, #f53d3d, #ff8c8c);
        }
        
        @keyframes pulse-small {
            from { transform: scale(1); }
            to { transform: scale(1.03); }
        }


        .info-box {
            background: rgba(0, 0, 0, 0.3); 
            padding: 8px 12px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .info-box .text-gray-500 {
            color: #d1d5da; 
        }
        .info-box .text-green-600 {
            color: #4ade80; 
        }

        /* Style Teks Status (Umum) */
        .colorful-status-text {
            display: block;
            text-align: center;
            font-size: 3rem; 
            line-height: 1;
            font-weight: 900;
            
            @media (min-width: 640px) { 
                font-size: 4rem;
            }
            @media (min-width: 1024px) { 
                font-size: 5rem; 
            }
            
            background: linear-gradient(90deg, #38A169, #9AE6B4); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #38A169; 
            text-shadow: 0 3px 10px rgba(56, 161, 105, 0.4); 
        }
        
        /* BARU/MODIFIKASI: Kotak Container untuk Hint Hangman (Oranye) */
        #hint-box-container {
            padding: 10px 20px;
            background: #f97316; /* Orange-600 */
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.5);
            margin-top: 15px;
            border: 3px solid #ea580c; /* Darker orange border */
        }
        
        /* Style KHUSUS untuk Tampilan Hint Hangman - inside the orange box */
        #hint-display {
             color: white; /* Text inside orange box should be white */
             font-size: 2.5rem; 
             letter-spacing: 0.5em; 
             font-weight: 700;
             line-height: 1.2;
             padding: 0;
             margin: 0;
             text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        /* Overlay untuk umpan balik (centang/silang) */
        #feedback-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .feedback-icon {
            font-size: 15vw; 
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            line-height: 1;
        }

        .feedback-text {
            font-size: 5vw;
            font-weight: 700;
            text-shadow: 2px 2px 5px #000000;
            margin-top: 10px;
            line-height: 1;
        }

        .listening-dot {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Animasi Emoticon Sedih Bergerak (Timeout) */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        
        .sad-moving-icon {
            animation: shake 0.5s infinite;
            font-size: 15vw; 
        }

        .chance-circle {
            fill: #ef4444; 
            transition: fill 0.3s ease-in-out;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            border-radius: 50%; 
        }
        .chance-circle.active {
            fill: #10B981; 
        }
        
        /* Tombol */
        .control-button {
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: 0 5px 0 0 #4b5563;
            transition: all 0.1s;
        }

        .control-button:active {
            box-shadow: 0 2px 0 0 #4b5563;
            transform: translateY(3px);
        }

    </style>
</head>
<body>

    <!-- Overlay Loading Awal -->
    <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-yellow-400/90 z-50 transition-opacity duration-500">
        <div class="p-8 rounded-xl flex flex-col items-center">
            <svg class="animate-spin h-20 w-20 text-orange-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" data-ui-key="LOADING_TEXT" class="text-3xl font-bold text-gray-800">
                Memuat kamera dan mikrofon...
            </p>
        </div>
    </div>
    
    <!-- Kontainer Utama Game -->
    <div id="game-container">
        <canvas id="snapshot-canvas" class="hidden"></canvas> 
        <video id="webcam-feed" autoplay playsinline class="hidden"></video>
        
        <!-- Status Area (Top - Score and Chances) -->
        <div id="status-area">
            
            <!-- 1. Tampilan Skor -->
            <div class="info-box flex flex-col items-start">
                <div data-ui-key="SCORE_TITLE" class="text-lg font-semibold text-gray-500">Skor Anda:</div>
                <div id="score-display" class="text-4xl font-bold text-green-600 mt-1">0</div>
            </div>

            <!-- 2. Indikator Mendengarkan / Mendeteksi -->
            <div id="listening-indicator" class="flex items-center space-x-2 p-3 rounded-full bg-blue-500 shadow-xl hidden">
                <span class="w-4 h-4 bg-white rounded-full inline-block listening-dot"></span>
                <span id="listening-text" class="text-white font-semibold text-xl" data-ui-key="LISTENING">Mendengarkan...</span>
            </div>
            
             <!-- 3. Tampilan Visual Kesempatan Menjawab -->
            <div class="info-box flex flex-col items-end">
                <div data-ui-key="ATTEMPTS_LEFT_TITLE" class="text-lg font-semibold text-gray-500">Sisa Kesempatan:</div>
                <div id="chance-circles-display" class="flex space-x-2 mt-1">
                    <svg class="w-6 h-6 chance-circle" id="chance-1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"/></svg>
                    <svg class="w-6 h-6 chance-circle" id="chance-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"/></svg>
                    <svg class="w-6 h-6 chance-circle" id="chance-3" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"/></svg>
                </div>
            </div>
        </div>

        <!-- Top Center Container (Countdown KECIL & Hint & Main Status di bagian bawah) -->
        <div id="top-center-container">
            
             <!-- Countdown Timer (KECIL) -->
             <div id="countdown-wrapper" class="hidden">
                <span data-ui-key="COUNTDOWN_LABEL" class="text-gray-700 font-semibold mr-2">Waktu Tersisa:</span>
                <div id="countdown-display" class="colorful-status-text">10</div>
             </div>

             <!-- Tampilan Hint Hangman (BARU: Dibungkus Kotak Orange dan disembunyikan) -->
             <div id="hint-box-container" class="hidden text-center">
                 <p id="hint-display" class="text-5xl font-extrabold tracking-widest leading-none">
                     _ _ _ _ _
                 </p>
             </div>
             
             <!-- Teks Status BESAR (IDLE, FINISHED, SEARCHING, WRONG GUESS) -->
             <!-- Diletakkan di bawah Countdown/Hint agar tetap di atas video -->
             <div id="main-status-message" data-ui-key="INITIAL_STATUS" class="colorful-status-text mt-24">Siap Bermain? Tekan Main!</div>
        </div>

        <!-- Overlay Umpan Balik (Centang/Silang/Sad Emoticon) -->
        <div id="feedback-overlay" class="hidden">
            <div id="feedback-icon" class="feedback-icon"></div>
            <div id="feedback-text" class="feedback-text text-white"></div>
        </div>


        <!-- Panel Kontrol (Bottom) -->
        <div id="control-panel" class="justify-center sm:justify-around">
            
            <!-- Pengaturan Bahasa -->
            <div class="flex flex-col items-center gap-2">
                <label for="language-select" data-ui-key="SELECT_LANG" class="text-sm font-semibold text-gray-300">Pilih Bahasa:</label>
                <select id="language-select" class="p-2 text-base rounded-lg bg-gray-700 border border-gray-500 text-white font-semibold">
                    <!-- Options filled by JS -->
                </select>
            </div>

            <!-- Tombol Utama Main/Stop -->
            <button id="toggle-detection-button" class="control-button bg-green-500 text-white hover:bg-green-600" onclick="toggleDetection()" disabled>
                <span data-ui-key="START_BUTTON">Main</span>
            </button>
            
        </div>
    </div>

    <script>
        // --- DEKLARASI GLOBAL ---
        var polySynth; 
        var recognition; 
        
        var isCameraActive = false;
        var currentObjectData = null; 
        var detectionIntervalId = null; // Untuk loop pemindaian objek
        var countdownIntervalId = null; 
        var countdownValue = 10; 
        var gameState = 'IDLE_WAITING_START'; 
        var attemptsLeft = 3; 
        var isIntentionalStop = false; 
        var isAudioInitialized = false;
        var currentScore = 0; 
        var messageTimeoutId = null; 
        var isListening = false; 
        var revealedLetters = []; 

        // Constants
        const DETECTION_INTERVAL = 1500; // Cek objek setiap 1.5 detik
        const MAX_ATTEMPTS = 3;
        const COUNTDOWN_TIME = 10; 
        const CANVAS_WIDTH = 640;
        const CANVAS_HEIGHT = 480;
        const SCORE_CORRECT = 5; 
        const SCORE_WRONG = -1; 
        const MESSAGE_DURATION = 3000; 
        const RESUME_DELAY = 3500; 
        const HELP_LETTERS_TO_REVEAL = 2; // Jumlah huruf yang dibuka saat 'help'

        // DOM elements
        const videoElement = document.getElementById('webcam-feed');
        const canvasElement = document.getElementById('snapshot-canvas');
        const loadingOverlay = document.getElementById('loading-overlay');
        const listeningIndicator = document.getElementById('listening-indicator');
        const listeningText = document.getElementById('listening-text');
        const toggleButton = document.getElementById('toggle-detection-button');
        const languageSelect = document.getElementById('language-select');
        const mainStatusMessage = document.getElementById('main-status-message');
        const countdownWrapper = document.getElementById('countdown-wrapper');
        const countdownDisplay = document.getElementById('countdown-display'); 
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackIcon = document.getElementById('feedback-icon');
        const feedbackText = document.getElementById('feedback-text');
        const scoreDisplay = document.getElementById('score-display'); 
        const hintBoxContainer = document.getElementById('hint-box-container'); // BARU: Kotak Petunjuk
        const hintDisplay = document.getElementById('hint-display'); 
        const chanceCircles = [ 
            document.getElementById('chance-1'),
            document.getElementById('chance-2'),
            document.getElementById('chance-3')
        ];
        
        // --- MULTI-LANGUAGE DATA ---
        const FULL_LANGUAGE_LIST = {
            'ID': { name: 'Bahasa Indonesia', code: 'id-ID', skip: ['lewat', 'loncat', 'skip', 'pass'], help: ['bantuan', 'tolong', 'petunjuk'] },
            'EN': { name: 'English (US)', code: 'en-US', skip: ['skip', 'pass'], help: ['help', 'hint'] },
        };
        

        const UI_STRINGS = {
            'ID': {
                TITLE: 'Game Tebak Suara Objek Tangan',
                SELECT_LANG: 'Pilih Bahasa:',
                INITIAL_STATUS: 'Siap Bermain? Tekan Main!',
                START_BUTTON: 'Main',
                STOP_BUTTON: 'Stop',
                LOADING_TEXT: 'Memuat kamera dan mikrofon...',
                SCORE_TITLE: 'Skor Anda:', 
                AWAITING_VOICE: 'Waktunya Menjawab! Sebutkan Nama Bendanya!',
                CORRECT_GUESS: 'Kerja Bagus!',
                WRONG_GUESS: 'Coba Lagi',
                TIMEOUT_FAIL_TEXT: 'Tetap Semangat',
                OUT_OF_ATTEMPTS: 'Kesempatan Habis! Jawabannya Adalah',
                ATTEMPTS_LEFT_TITLE: 'Sisa Kesempatan:',
                LISTENING: 'Mendengarkan...',
                DETECTING: 'Mendeteksi Objek...',
                GAME_OVER: 'Permainan Selesai. Tekan Main Lagi.',
                OBJECT_FOUND: 'Objek Terdeteksi!',
                SKIP_ANNOUNCEMENT: 'Permintaan lewat diterima. Melompati benda ini.',
                HELP_ANNOUNCEMENT: 'Bantuan diberikan! Ayo tebak sekarang.',
                COUNTDOWN_LABEL: 'Waktu Tersisa:'
            },
            'EN': {
                TITLE: 'Handheld Object Voice Guessing Game',
                SELECT_LANG: 'Select Language:',
                INITIAL_STATUS: 'Ready To Play? Press Play!',
                START_BUTTON: 'Play',
                STOP_BUTTON: 'Stop',
                LOADING_TEXT: 'Loading camera and microphone...',
                SCORE_TITLE: 'Your Score:', 
                AWAITING_VOICE: 'Time to Answer! Say the Object Name!',
                CORRECT_GUESS: 'Great Job!',
                WRONG_GUESS: 'Try Again',
                TIMEOUT_FAIL_TEXT: 'Keep Going',
                OUT_OF_ATTEMPTS: 'Chances Up! The Answer Was',
                ATTEMPTS_LEFT_TITLE: 'Chances Left:',
                LISTENING: 'Listening...',
                DETECTING: 'Detecting Object...',
                GAME_OVER: 'Game Over. Press Play Again.',
                OBJECT_FOUND: 'Object Detected!',
                SKIP_ANNOUNCEMENT: 'Skip request acknowledged. Skipping this object.',
                HELP_ANNOUNCEMENT: 'Hint provided! Guess now.',
                COUNTDOWN_LABEL: 'Time Left:'
            },
        };

        // --- SPEECH AND UTILITY FUNCTIONS ---

        function initAudio() {
            if (isAudioInitialized) return;
            polySynth = new Tone.PolySynth(Tone.Synth, {
                volume: -10,
                oscillator: { type: 'sine' },
                envelope: { 
                    attack: 0.005, 
                    decay: 0.1, 
                    sustain: 0.3, 
                    release: 1 
                }
            }).toDestination();
            isAudioInitialized = true;
        }

        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                if (!recognition) { 
                    recognition = new SpeechRecognition();
                    recognition.continuous = false; 
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    setupRecognitionHandlers();
                }
            } else {
                 console.error("Speech Recognition API not supported in this browser.");
                 setMainStatusMessage("Speech Recognition Not Supported!", true);
            }
        }

        function getSelectedLangKey() {
            return languageSelect.value;
        }

        function getSelectedLangData() {
            const selectedKey = languageSelect.value;
            return FULL_LANGUAGE_LIST[selectedKey] || FULL_LANGUAGE_LIST['EN']; 
        }

        function getSelectedLangCode() {
            return getSelectedLangData().code;
        }
        
        function getStrings() {
            const selectedKey = getSelectedLangKey();
            return UI_STRINGS[selectedKey] || UI_STRINGS['EN']; 
        }

        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            
            window.speechSynthesis.cancel();
            const langCode = getSelectedLangCode();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            
            const voices = window.speechSynthesis.getVoices();
            const voice = voices.find(v => v.lang === langCode) || voices.find(v => v.lang.startsWith(langCode.substring(0, 2)));
            if (voice) {
                utterance.voice = voice;
            }
            
            window.speechSynthesis.speak(utterance);
        }

        async function playFeedbackSound(isCorrect) {
            await Tone.start();
            initAudio(); 

            if (isCorrect) {
                polySynth.triggerAttackRelease(["C5", "E5", "G5"], "4n");
            } else if (isCorrect === 'found') {
                 polySynth.triggerAttackRelease(["E4", "G4"], "8n"); // Suara Deteksi
            } else {
                polySynth.triggerAttackRelease("C4", "8n");
            }
        }
        
        // --- HINT/HANGMAN FUNCTIONS ---
        
        function initHint() {
            // Reset revealed letters based on the new object
            if (currentObjectData && currentObjectData.label) {
                revealedLetters = new Array(currentObjectData.label.length).fill(null);
            } else {
                revealedLetters = [];
            }
        }
        
        function getHintDisplay() {
            if (!currentObjectData) return '---';
            const label = currentObjectData.label.toLowerCase();
            let display = '';
            
            for (let i = 0; i < label.length; i++) {
                if (revealedLetters[i] !== null) {
                    display += label[i].toUpperCase();
                } else if (label[i] === ' ') {
                    display += ' / '; 
                } else {
                    display += '_';
                }
                display += ' '; 
            }
            return display.trim();
        }
        
        function revealRandomLetters(count) {
            if (!currentObjectData) return;
            const label = currentObjectData.label.toLowerCase();
            let unrevealedIndices = [];

            for (let i = 0; i < label.length; i++) {
                if (revealedLetters[i] === null && label[i] !== ' ') {
                    unrevealedIndices.push(i);
                }
            }
            
            if (unrevealedIndices.length === 0) {
                console.log("No unrevealed letters left.");
                return;
            }
            
            unrevealedIndices.sort(() => 0.5 - Math.random());
            const indicesToReveal = unrevealedIndices.slice(0, count);

            indicesToReveal.forEach(index => {
                revealedLetters[index] = label[index];
            });
            
            hintDisplay.textContent = getHintDisplay();
        }

        // --- COUNTDOWN & TIMER FUNCTIONS ---
        
        function startCountdown() {
            stopCountdown(); 
            
            countdownValue = COUNTDOWN_TIME;
            countdownDisplay.textContent = countdownValue;
            countdownDisplay.classList.remove('urgent');

            mainStatusMessage.classList.remove('mt-24'); // Atur ulang posisi status utama agar tidak mengganggu
            mainStatusMessage.classList.add('mt-8');
            countdownWrapper.classList.remove('hidden'); 
            // hintDisplay.classList.remove('hidden'); <-- Dihapus. Hint sekarang dikontrol oleh 'help'

            countdownIntervalId = setInterval(() => {
                countdownValue--;
                countdownDisplay.textContent = countdownValue;

                if (countdownValue <= 3) {
                    countdownDisplay.classList.add('urgent');
                } else {
                    countdownDisplay.classList.remove('urgent');
                }

                if (countdownValue <= 0) {
                    handleTimeoutSkip(); // Panggil fungsi saat hitungan mundur selesai
                }
            }, 1000);
        }

        function stopCountdown() {
            if (countdownIntervalId) {
                clearInterval(countdownIntervalId);
                countdownIntervalId = null;
            }
            countdownWrapper.classList.add('hidden'); 
            // hintDisplay.classList.add('hidden'); <-- Dihapus. Hint sekarang dikontrol oleh 'help'
        }

        function handleTimeoutSkip() {
            stopCountdown();
            stopListening(); 
            hintBoxContainer.classList.add('hidden'); // BARU: Sembunyikan petunjuk
            
            const strings = getStrings();

            attemptsLeft--; 
            currentScore += SCORE_WRONG;
            updateScoreDisplay();
            updateAttemptTrackers();
            
            showSadFeedback(strings.TIMEOUT_FAIL_TEXT); // Tampilkan emoticon sedih

            // Jika masih ada kesempatan, mulai lagi deteksi objek baru
            if (attemptsLeft > 0) {
                 speak(`${strings.TIMEOUT_FAIL_TEXT}! Mencari objek baru...`);
                 setTimeout(() => startDetectionLoop(true), RESUME_DELAY); // Reset attempts dan mulai deteksi lagi
            } else {
                // Game Over
                gameState = 'FINISHED';
                updateUI(); 
                speak(`${strings.OUT_OF_ATTEMPTS} ${currentObjectData.label}! ${strings.GAME_OVER}`);
                stopDetection(); 
            }
        }

        // --- UI AND LOCALIZATION FUNCTIONS ---

        function updateScoreDisplay() {
            scoreDisplay.textContent = currentScore;
            if (currentScore >= 0) {
                scoreDisplay.classList.remove('text-red-500');
                scoreDisplay.classList.add('text-green-600');
            } else {
                scoreDisplay.classList.remove('text-green-600');
                scoreDisplay.classList.add('text-red-500');
            }
        }
        
        function clearMessageTimeout() {
            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
                messageTimeoutId = null;
            }
        }

        function setMainStatusMessage(text, isTemporary = false) {
            clearMessageTimeout();
            
            // Sembunyikan hitungan mundur/hint, tampilkan pesan teks besar
            stopCountdown(); 
            hintBoxContainer.classList.add('hidden'); // Sembunyikan saat status besar tampil
            mainStatusMessage.classList.remove('hidden');
            mainStatusMessage.textContent = text;
            mainStatusMessage.className = 'colorful-status-text mt-24'; // Reset ke posisi idle
            
            if (isTemporary) {
                messageTimeoutId = setTimeout(() => {
                    if (gameState === 'SEARCHING_OBJECT') {
                         setMainStatusMessage(getStrings().DETECTING);
                         mainStatusMessage.classList.remove('mt-24');
                    } else if (gameState === 'AWAITING_VOICE_GUESS') {
                         // Kembali ke mode menebak/timer
                         setAwaitingVoiceState();
                    } else {
                        updateUI();
                    }
                }, MESSAGE_DURATION);
            }
        }
        
        // Fungsi untuk mengatur UI ke status AWAITING_VOICE_GUESS
        function setAwaitingVoiceState() {
             const strings = getStrings();
             
             // Atur ulang posisi status utama ke posisi menebak (lebih ke atas)
             mainStatusMessage.classList.remove('mt-24');
             mainStatusMessage.classList.add('mt-8');
             mainStatusMessage.textContent = strings.AWAITING_VOICE;
             
             // Pastikan Hint Box tersembunyi saat mode tebak dimulai (hanya tampil setelah 'help')
             hintBoxContainer.classList.add('hidden'); 
             
             hintDisplay.textContent = getHintDisplay();
             startCountdown(); 
             
             // Mulai mendengarkan
             startListening();
        }

        function updateUI() {
            const strings = getStrings();
            
            document.querySelectorAll('[data-ui-key]').forEach(el => {
                const key = el.getAttribute('data-ui-key');
                if (strings[key]) {
                    if (el.tagName === 'TITLE') {
                        document.title = strings[key];
                    } else if (el !== mainStatusMessage) { 
                        el.textContent = strings[key];
                    }
                }
            });

            // Perbarui tombol & tampilan indikator
            if (gameState === 'SEARCHING_OBJECT' || gameState === 'AWAITING_VOICE_GUESS') {
                toggleButton.textContent = strings.STOP_BUTTON;
                toggleButton.classList.replace('bg-green-500', 'bg-red-500');
                toggleButton.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
            } else { 
                toggleButton.textContent = strings.START_BUTTON;
                toggleButton.classList.replace('bg-red-500', 'bg-green-500');
                toggleButton.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
            }

            // Perbarui pesan status utama
            if (gameState === 'IDLE_WAITING_START' && isCameraActive) {
                setMainStatusMessage(strings.INITIAL_STATUS);
                listeningIndicator.classList.add('hidden'); 
            } else if (gameState === 'FINISHED') {
                 setMainStatusMessage(strings.GAME_OVER);
                 listeningIndicator.classList.add('hidden'); 
            } else if (gameState === 'SEARCHING_OBJECT') {
                 listeningText.textContent = strings.DETECTING;
                 listeningIndicator.classList.remove('hidden'); 
                 setMainStatusMessage(strings.DETECTING); // Status besar
                 mainStatusMessage.classList.remove('mt-24');
                 stopCountdown();
            } 
            
            updateAttemptTrackers();
            updateScoreDisplay(); 
        }


        function fillLanguageDropdown() {
            const defaultKey = 'ID'; 
            languageSelect.innerHTML = ''; 
            
            Object.entries(FULL_LANGUAGE_LIST).forEach(([key, langData]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = langData.name;
                if (key === defaultKey) option.selected = true;
                languageSelect.appendChild(option);
            });
        }
        
        function updateAttemptTrackers() {
            chanceCircles.forEach((circle, index) => {
                if (index < attemptsLeft) {
                    circle.classList.add('active'); 
                    circle.style.opacity = '1';
                } else {
                    circle.classList.remove('active'); 
                    circle.style.opacity = '0.4';
                }
            });
        }
        
        function hideOverlays() {
            feedbackOverlay.classList.add('hidden');
            feedbackOverlay.style.opacity = '0';
        }
        
        function showFeedback(isCorrect) {
            const strings = getStrings();
            hideOverlays();
            
            feedbackOverlay.classList.remove('hidden');
            feedbackIcon.classList.remove('sad-moving-icon');
            hintBoxContainer.classList.add('hidden'); // Sembunyikan hint saat feedback benar/salah

            if (isCorrect) {
                feedbackIcon.innerHTML = 'ðŸ¤©'; 
                feedbackIcon.style.color = '#10B981'; 
                feedbackText.textContent = `(+${SCORE_CORRECT} Poin) - ${strings.CORRECT_GUESS}`; 
                feedbackText.style.color = '#10B981';
                playFeedbackSound(true);
                speak(strings.CORRECT_GUESS);
            } else {
                feedbackIcon.innerHTML = 'ðŸ¥º'; 
                feedbackIcon.style.color = '#EF4444'; 
                feedbackText.textContent = `(${SCORE_WRONG} Poin) - ${strings.WRONG_GUESS}`; 
                feedbackText.style.color = '#EF4444';
                playFeedbackSound(false);
                speak(strings.WRONG_GUESS);
            }
            
            setTimeout(() => {
                feedbackOverlay.style.opacity = '1';
            }, 50);

            // Sembunyikan umpan balik setelah 3 detik
            setTimeout(hideOverlays, 3000); 
        }
        
        // FUNGSI KHUSUS UNTUK TIMEOUT
        function showSadFeedback(message) {
            hideOverlays();
            
            feedbackOverlay.classList.remove('hidden');
            
            feedbackIcon.innerHTML = 'ðŸ˜¢'; 
            feedbackIcon.style.color = '#4f46e5'; // Biru Ungu
            feedbackIcon.classList.add('sad-moving-icon'); // Aktifkan animasi
            
            feedbackText.textContent = message; 
            feedbackText.style.color = '#4f46e5';

            setTimeout(() => {
                feedbackOverlay.style.opacity = '1';
            }, 50);

            // Sembunyikan setelah 3 detik dan mulai loop deteksi
            setTimeout(hideOverlays, 3000); 
        }

        // --- CAMERA & SNAPSHOT FUNCTIONS ---

        function startCamera() {
            const strings = getStrings();

            loadingOverlay.style.opacity = '1';
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { width: CANVAS_WIDTH, height: CANVAS_HEIGHT }, 
                    audio: true 
                })
                    .then(stream => {
                        stream.getAudioTracks().forEach(track => track.stop());
                        
                        videoElement.srcObject = stream;
                        videoElement.classList.remove('hidden');
                        videoElement.onloadedmetadata = () => {
                            canvasElement.width = videoElement.videoWidth;
                            canvasElement.height = videoElement.videoHeight;

                            videoElement.play();
                            isCameraActive = true;
                            
                            toggleButton.disabled = false;
                            
                            loadingOverlay.style.opacity = '0';
                            loadingOverlay.addEventListener('transitionend', () => {
                                loadingOverlay.classList.add('hidden');
                            }, { once: true });
                            
                            gameState = 'IDLE_WAITING_START';
                            updateUI();
                        };
                    })
                    .catch(error => {
                        console.error("Error accessing camera/mic: ", error);
                        setMainStatusMessage(strings.INITIAL_STATUS + " (Permission Denied)");
                        loadingOverlay.style.opacity = '0';
                        loadingOverlay.addEventListener('transitionend', () => {
                            loadingOverlay.classList.add('hidden');
                        });
                    });
            } else {
                setMainStatusMessage(strings.INITIAL_STATUS + " (Browser Not Supported)");
                loadingOverlay.style.opacity = '0';
                loadingOverlay.addEventListener('transitionend', () => {
                    loadingOverlay.classList.add('hidden');
                }, { once: true });
            }
        }

        function takeSnapshot() {
            const context = canvasElement.getContext('2d');
            context.drawImage(videoElement, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            return canvasElement.toDataURL('image/jpeg', 0.8).split(',')[1];
        }
        
        // --- API & LOGIC FUNCTIONS ---
        
        function checkGuess(transcript) {
            const strings = getStrings();
            
            stopListening(); 
            
            if (currentObjectData && currentObjectData.label) {
                const targetLabel = currentObjectData.label.toLowerCase().trim();
                const guess = transcript.toLowerCase().trim();
                const langData = getSelectedLangData();
                
                const isHelpCommand = langData.help.some(term => guess.includes(term));
                if (isHelpCommand) {
                    setMainStatusMessage(strings.HELP_ANNOUNCEMENT, true); 
                    revealRandomLetters(HELP_LETTERS_TO_REVEAL);
                    
                    // --- BARU: Tampilkan kotak petunjuk setelah bantuan diminta ---
                    hintBoxContainer.classList.remove('hidden');
                    
                    setTimeout(() => {
                        if (gameState === 'AWAITING_VOICE_GUESS') {
                             setAwaitingVoiceState(); 
                        }
                    }, RESUME_DELAY);
                    return; 
                }
                
                const isSkipCommand = langData.skip.some(term => guess.includes(term));
                if (isSkipCommand) {
                    setMainStatusMessage(strings.SKIP_ANNOUNCEMENT, true); 
                    
                    attemptsLeft--;
                    currentScore += SCORE_WRONG;
                    updateScoreDisplay();
                    updateAttemptTrackers();

                    if (attemptsLeft <= 0) {
                        gameState = 'FINISHED';
                        updateUI(); 
                        speak(`${strings.OUT_OF_ATTEMPTS} ${currentObjectData.label}! ${strings.GAME_OVER}`);
                        stopDetection(); 
                        return;
                    }
                    
                    speak(strings.SKIP_ANNOUNCEMENT);
                    // Langsung ke deteksi objek baru setelah skip
                    setTimeout(() => startDetectionLoop(true), RESUME_DELAY); 
                    return; 
                }

                // 3. Periksa Jawaban Benar
                if (guess.includes(targetLabel) || targetLabel.includes(guess) || targetLabel.replace(/\s+/g, '').includes(guess.replace(/\s+/g, ''))) {
                    currentScore += SCORE_CORRECT;
                    showFeedback(true);
                    updateScoreDisplay();
                    
                    stopCountdown(); 
                    // Langsung ke deteksi objek baru setelah benar
                    setTimeout(() => startDetectionLoop(true), RESUME_DELAY); 
                    return;
                }
            }

            // 4. Jawaban Salah
            attemptsLeft--;
            currentScore += SCORE_WRONG;
            showFeedback(false);
            updateScoreDisplay();
            updateAttemptTrackers();

            if (attemptsLeft <= 0) {
                stopCountdown();
                gameState = 'FINISHED';
                updateUI(); 
                speak(`${strings.OUT_OF_ATTEMPTS} ${currentObjectData.label}! ${strings.GAME_OVER}`);
                stopDetection(); 
            } else {
                setMainStatusMessage(getStrings().WRONG_GUESS, true); 
                
                setTimeout(() => {
                    if (gameState === 'AWAITING_VOICE_GUESS') {
                         setAwaitingVoiceState();
                    }
                }, RESUME_DELAY);
            }
        }
        
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) { 
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function fetchObjectDetection() {
            if (gameState !== 'SEARCHING_OBJECT') return;

            const base64Image = takeSnapshot();
            if (!base64Image) {
                 console.error("Failed to capture image snapshot during detection.");
                 return;
            }
            
            const strings = getStrings();

            const userPrompt = "Identify the single, most prominent object being held in the person's hand in this image. Do not describe the person or the background. Respond only with a single, common, non-plural English noun for the handheld item. For example: 'key', 'cup', or 'phone'. Do not include quotes, articles, or any other text.";
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userPrompt },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: "You are an object detection model for a voice guessing game. Focus exclusively on the small object being held by the user. Your response must be a single, non-plural English noun that is easy to guess." }]
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toLowerCase();

                if (text && text.length > 1 && gameState === 'SEARCHING_OBJECT') {
                    // --- BERHASIL DETEKSI! ---
                    stopDetectionLoop(); 
                    
                    currentObjectData = { label: text, source: 'gemini' };
                    console.log('Detected Object:', currentObjectData.label);
                    
                    // 1. Keluarkan suara/pesan "Objek Terdeteksi!"
                    playFeedbackSound('found');
                    speak(strings.OBJECT_FOUND);

                    // 2. Transisi ke mode menebak
                    gameState = 'AWAITING_VOICE_GUESS';
                    initHint();
                    
                    // 3. Set UI ke mode menebak dan mulai hitungan mundur
                    setTimeout(() => {
                         setAwaitingVoiceState();
                    }, 500); // Jeda singkat setelah pengumuman
                    
                } else {
                    console.info("No clear handheld object detected, continuing detection loop.");
                }

            } catch (error) {
                console.error("API Fetch Error:", error);
                // Hanya log error, biarkan loop deteksi berlanjut
            }
        }
        
        // --- SPEECH RECOGNITION HANDLERS ---
        
        function setupRecognitionHandlers() {
            if (!recognition) return;
            recognition.lang = getSelectedLangCode(); 

            recognition.onstart = () => {
                isListening = true; 
                listeningText.textContent = getStrings().LISTENING;
                listeningIndicator.classList.remove('hidden');
            };

            recognition.onend = () => {
                isListening = false; 
                if (gameState !== 'SEARCHING_OBJECT') {
                    listeningIndicator.classList.add('hidden');
                }
                isIntentionalStop = false; 
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('Result:', transcript);
                checkGuess(transcript); 
            };
            
            recognition.onerror = (event) => {
                isListening = false; 
                if (gameState !== 'SEARCHING_OBJECT') {
                     listeningIndicator.classList.add('hidden');
                }
                
                if (event.error !== 'aborted' && event.error !== 'no-speech') {
                    console.error('Speech recognition error:', event.error); 
                }

                if (['not-allowed', 'network'].includes(event.error)) {
                    stopDetection();
                    setMainStatusMessage(`Error: ${event.error}. Stopping game.`, 5000);
                }
            };
        }

        function stopListening() {
            if (recognition && isListening) {
                isIntentionalStop = true; 
                recognition.abort(); 
                isListening = false;
                if (gameState !== 'SEARCHING_OBJECT') {
                     listeningIndicator.classList.add('hidden');
                }
            }
        }

        function startListening() {
            if (!recognition) return;
            if (isListening) return;
            
            isListening = true;
            isIntentionalStop = false; 

            try {
                recognition.lang = getSelectedLangCode(); 
                recognition.start();
            } catch (error) {
                if (error.name === 'InvalidStateError' && (error.message.includes('already started') || error.message.includes('busy'))) {
                    recognition.abort(); 
                    isListening = false; 
                    setTimeout(startListening, 500);
                } else {
                    console.error("Error starting speech recognition:", error);
                    isListening = false;
                }
            }
        }
        
        // --- GAME FLOW FUNCTIONS ---
        
        function startDetectionLoop(resetAttempts = false) {
             // Hentikan aktivitas sebelumnya
            stopListening();
            stopCountdown();
            stopDetectionLoop();
            hintBoxContainer.classList.add('hidden'); // Pastikan tersembunyi

            if (resetAttempts) {
                attemptsLeft = MAX_ATTEMPTS;
                updateAttemptTrackers();
            }

            gameState = 'SEARCHING_OBJECT';
            updateUI(); 
            
            // Panggil API segera dan set interval
            fetchObjectDetection(); 
            detectionIntervalId = setInterval(fetchObjectDetection, DETECTION_INTERVAL);
        }
        
        function stopDetectionLoop() {
            if (detectionIntervalId) {
                clearInterval(detectionIntervalId);
                detectionIntervalId = null;
            }
            if (gameState === 'SEARCHING_OBJECT') {
                 listeningIndicator.classList.add('hidden');
            }
        }

        function toggleDetection() {
            if (gameState === 'IDLE_WAITING_START' || gameState === 'FINISHED') {
                // Mulai permainan
                currentScore = 0;
                updateScoreDisplay();
                
                startDetectionLoop(true); // Reset attempts dan mulai loop deteksi

            } else {
                // Hentikan permainan
                stopDetection();
            }
        }
        
        function stopDetection() {
            // Hentikan Pengenalan Suara, Timer, dan Interval Deteksi
            stopListening();
            stopCountdown();
            stopDetectionLoop();

            // Reset Status Game
            gameState = 'IDLE_WAITING_START'; 
            currentObjectData = null;
            attemptsLeft = MAX_ATTEMPTS;
            revealedLetters = []; 
            hintBoxContainer.classList.add('hidden'); // Sembunyikan petunjuk
            updateUI(); 
        }

        function initApp() {
            const strings = getStrings();
             if (!('speechSynthesis' in window) || !('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.error('Browser does not support the necessary APIs for this game.');
                document.getElementById('toggle-detection-button').disabled = true; 
                
                const loadingText = document.getElementById('loading-text');
                loadingText.textContent = "Browser Anda tidak mendukung API yang diperlukan. Game tidak dapat dimuat.";
                const spinner = document.querySelector('#loading-overlay svg');
                if (spinner) spinner.classList.add('hidden');
                
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    loadingOverlay.addEventListener('transitionend', () => {
                        loadingOverlay.classList.add('hidden');
                    }, { once: true });
                }, 4000); 
                
                return;
            }
            
            initSpeech();
            
            fillLanguageDropdown();
            languageSelect.addEventListener('change', () => {
                // Atur ulang pengenalan suara saat bahasa berubah
                setupRecognitionHandlers(); 
                updateUI();
            }); 
            updateUI();
            
            startCamera();
        }

        window.onload = initApp;

    </script>
</body>
</html>
